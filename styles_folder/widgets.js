
Ext.ns("bpo.widget");bpo.widget.TextWidget=Ext.extend(bpo.widget.Widget,{type:'TextWidget',componentName:'textWidget',editor:false,data:null,lastSavedText:'',serverFilteredHtml:null,saveInterval:30000,saveTimeoutId:0,maxChars:400000,clickToEditTextEmpty:'Click to start writing this text',clickToEditTextNotEmpty:'Click to edit this text',isSaving:false,constructor:function(config){var textarea;Ext.apply(this,config);if(this.getEl().child('.textWidget-text')){textarea=this.getEl().child('.textWidget-text');this.data=textarea.getValue();this.maxChars=parseInt(textarea.getAttribute('maxchars')||this.maxChars,10);}
this.eventTypes={"TextWidget.updated":this.handleTextWidgetUpdated};bpo.widget.TextWidget.superclass.constructor.call(this,config);},handleTextWidgetUpdated:function(registry,widget){},initEditor:function(text){var id=this.getEl().child('.textarea-wrapper').id,thisClosure=this,editor,CKConfig={language:'en',customConfig:'',autoUpdateElement:false,toolbar:[['Bold','Italic','Underline'],['NumberedList','BulletedList','Blockquote']],toolbarCanCollapse:false,scayt_autoStartup:false,resize_dir:'vertical',removePlugins:'colordialog,contextmenu,dialog, flash, forms, image, link, scayt, smiley, specialchar, styles, table, tabletools, templates, wsc, elementspath,colorbutton,filebrowser,horizontalrule,print,preview',extraPlugins:'wordcount,autogrow,charcount,pastefromword,clipboard,whitelisttags',height:100,width:630,autoGrow_minHeight:100,autoGrow_maxHeight:300,disableNativeSpellChecker:true,charcount_maxchars:this.maxChars};if(Ext.isSafari){CKConfig.height=300;CKConfig.extraPlugins=CKConfig.extraPlugins.replace('autogrow,','');}
var readyFn;readyFn=function(e){if(e.editor===editor&&window.CKEDITOR){window.CKEDITOR.removeListener('instanceReady',readyFn);thisClosure.getEl().addClass('ckeditor-ready');thisClosure.lastSavedText=editor.getData();var focusManager=window.CKEDITOR.focusManager(e.editor);setTimeout(function(){e.editor.document.$.body.spellcheck=true;},500);}};window.CKEDITOR.on('instanceReady',readyFn);if(this.serverFilteredHtml!==null){this.data=this.serverFilteredHtml;}
editor=window.CKEDITOR.appendTo(id,CKConfig,this.data);this.editor=editor;},clearData:function(){if(this.editor){this.editor.setData('');}},save:function(){if(!bpo.online||Ext.WindowMgr.getActive()!==null){return;}
else{if(this.editor){this.data=this.editor.getData();this.data=this.data.replace(/^(\n|\s|<p>(\s|&nbsp;)*<\/p>)*/i,'');var reversed=this.data.split('').reverse().join('');reversed=reversed.replace(/^(\n|\s|>p\/<(\s|;psbn&)*>p<)*/i,'');this.data=reversed.split('').reverse().join('');}
var jComp=this.getComponent();jComp.setText(this.id,this.data,this.setTextCallback.createDelegate(this));if(window.debug&&this.getEl().child('textarea.textarea-debug')){this.getEl().child('textarea.textarea-debug').dom.innerText=this.data;}
this.isSaving=true;this.lastSavedText=this.data;}},setTextCallback:function(filteredHtml){if(filteredHtml!==null){this.isSaving=false;this.serverFilteredHtml=filteredHtml;this.saved();this.updatePreview(filteredHtml);if(!this.editing){this.data=filteredHtml;this.lastSavedData=filteredHtml;if(this.editor){this.editor.setData(filteredHtml);}}}},saveIfDirty:function(){if(this.hasUnsavedProgress()){this.save();}
if(this.editing){this.saveTimeoutId=setTimeout(this.saveIfDirty.createDelegate(this),this.saveInterval);}},hasUnsavedProgress:function(){if(!this.editor||!this.editing){return false;}
var data=this.editor.getData();if(!this.editing||data===null){return false;}else{return this.lastSavedText!==data;}},updatePreview:function(content){if(!this||!this.getEl()){return;}
if(content){this.getEl().child('.preview').update(content);}else{if(this.data){if(this.getEl()!==null){this.getEl().child('.preview').update(this.data);}}
if(this.data===""){this.updateClickToEditText(this.clickToEditTextEmpty);}else{this.updateClickToEditText(this.clickToEditTextNotEmpty);}}},isSlateClean:function(){var text=this.data;if(!text){return true;}
var stripped;stripped=Ext.util.Format.stripTags(text).replace(/\s|\n|&nbsp;/g,'');return stripped==="";},destroyEditor:function(){if(!this){return;}
if(this.getEl()){this.getEl().removeClass('ckeditor-ready');}
if(this.saveTimeoutId){clearTimeout(this.saveTimeoutId);}
this.lastSavedText='';if(this.editor){var ed=this.editor;var fn=function(){ed.destroy(true);};fn.defer(1000,this);}
this.editor=false;},edit:function(){if(!CKEDITOR.env.isCompatible){bpo.message.alert("Mobile Safari (the browser you are using) does not support the editing of rich text content. As a result, you can view but not edit the written content from your plan on this device.".l());return;}
bpo.widget.TextWidget.superclass.edit.call(this);if(!this.editor){this.initEditor();this.saveTimeoutId=setTimeout(this.saveIfDirty.createDelegate(this),this.saveInterval);}else{this.editor.focus();}
this.getComponent().editText();},preview:function(){if(this.editor){var focusManager=CKEDITOR.focusManager(this.editor);focusManager.forceBlur();this.isSaving=false;this.save();this.destroyEditor();}else{this.updatePreview();}
bpo.widget.TextWidget.superclass.preview.call(this);},sortStart:function(){this.data=this.editor&&this.editor.getData?this.editor.getData():undefined;this.save();this.destroyEditor();bpo.widget.TextWidget.superclass.sortStart.call(this);},sortStop:function(){bpo.widget.TextWidget.superclass.sortStop.call(this);this.initEditor.defer(100,this);},useExample:function(e,target){try{var exampleSource=Ext.fly(target).parent('.examples-container').child('.example.page{display!=none}').child('.example-source').getValue();this.editor.insertHtml(exampleSource||'');this.editor.execCommand('wordcount',{force:true});}catch(ex){}},saveData:function(){},loaded:function(textContent){},destroy:function(){}});Ext.ns("bpo.widget.SalesForecastWidget");bpo.widget.SalesForecastWidget=Ext.extend(bpo.widget.Widget,{type:'SalesForecast',componentName:'salesForecast',sortable:null,constructor:function(config){Ext.apply(this,config);bpo.widget.SalesForecastWidget.superclass.constructor.call(this,config);},init:function(){window.salesForecast.init();var sortableEl=this.getEl().child('.line-items');this.sortable=$j(sortableEl.dom).sortable({containment:'.container',items:'.line-item',tolerance:'pointer',handle:'.drag-handle',update:function(event,ui){var order=[];Ext.select('.line-item').each(function(el){if(!Ext.fly(el).hasClass('template')){order.push(Ext.fly(el).getAttribute('rel'));}});bpo.setSortableItemBusy(ui.item);window.salesForecast.setProductOrder(order,window.reRenderSFPreview);}});this.getEl().on({click:function(e,el){if(Ext.fly(el).is('.trash')){var removeFn=function(id){if(id==='yes'){var target=Ext.get(el).parent('.line-item'),uuid=target.getAttribute('rel');if(window.deleteProduct){bpo.blockUI();window.deleteProduct(uuid);}
target.ghost('b',{remove:false,callback:function(){target.update('').slideOut('t',{remove:true,scope:this,callback:function(){this.updateAddProductText();this.dataChanged();}});},scope:this});}};bpo.message.confirm(false,'Are you sure you want to remove this product or service from your forecast?'.l(),removeFn,this);}
if(Ext.fly(el).findParent('.forecast')){var uuid=Ext.fly(el).findParent('.forecast').getAttribute('rel');bpo.dimAjaxArea('dim-action-active-page');window.location="/sales-forecast?selectedProduct="+uuid;}},change:function(e,el){if(Ext.get(el).parent('.line-item')){var uuid=Ext.get(el).parent('.line-item').getAttribute('rel');bpo.blockUI();window.renameProduct(uuid,el.value);}},scope:this});$j('.forecast, .trash').live('touchend',function(e,el){$j(this).click();});this.on('preview',function(){bpo.previewTable.init();});},handleAddLinkClick:function(add_link){bpo.blockUI();$j(add_link).fadeTo(0,0.4);var dummy_line_item=$j(".line-item.template").clone();dummy_line_item.removeClass("template");dummy_line_item.addClass("remove-me");bpo.setSortableItemBusy(dummy_line_item);dummy_line_item.css("display","block");$j("div.lineItems-widgetForm div.line-item:last").after(dummy_line_item);},updateAddProductText:function(){var addLink=this.getEl().child('a.add-another-product');var products=this.getEl().select('.line-item').getCount()-1;if(products===0){addLink.update('You have no products or services. Click here to add one now'.l());}},reRendered:function(){this.updateAddProductText();this.getEl().select('input[type=text]').last().dom.select();},isSlateClean:function(){return this.cleanSlateFlag;},setCleanSlateFlag:function(cleanSlateFlag){if(this.cleanSlateFlag!==cleanSlateFlag){this.cleanSlateFlag=cleanSlateFlag;if(this.cleanSlateFlag===false){window.reRenderSFPreview();}
if(this.editing===false){this.preview();}}},hasProducts:function(){if(this.getEl()){return(this.getEl().select('.line-item').getCount()>0);}},edit:function(){bpo.widget.SalesForecastWidget.superclass.edit.call(this);this.getEl().select('.x-hidden').removeClass('.x-hidden');this.updateAddProductText();},dataChanged:function(){bpo.eventbus.fireEvent('plandatachange','salesForecast');}});Ext.ns("bpo.widget.ExpenseBudget");bpo.widget.ExpenseBudget=Ext.extend(bpo.widget.Widget,{type:'ExpenseBudget',componentName:'expenseBudget',sortable:null,constructor:function(config){Ext.apply(this,config);bpo.widget.ExpenseBudget.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},editClicked:false,edit:function(){if(!this.editClicked){this.editClicked=true;bpo.dimAjaxArea('dim-action-active-page');window.location="/expense-budget";}}});Ext.ns("bpo.widget.ProfitAndLoss");bpo.widget.ProfitAndLoss=Ext.extend(bpo.widget.Widget,{type:'ProfitAndLoss',componentName:'profitAndLoss',sortable:null,cleanSlateFlag:false,constructor:function(config){Ext.apply(this,config);bpo.widget.ProfitAndLoss.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},setCleanSlateFlag:function(isCleanSlateFlag){this.cleanSlateFlag=isCleanSlateFlag;if(this.editing===false){this.preview();}},editClicked:false,edit:function(){var cfg={buttonText:{yes:'OK'.l(),no:'',or:''}};bpo.message.alert('<p>'+"The profit and loss statement is a <strong>view-only</strong> table that brings together elements of the other "+"financial tables. To change it, edit the underlying data in the ".l()+"<a href='/sales-forecast'>"+this.salesForecastTitle+"</a>, "+"<a href='/expense-budget'>"+this.expenseBudgetTitle+"</a>, "+"and".l()+" <a href='/personnel-plan'>"+this.personnelTitle+"</a>."+"</p>","Editing the P&amp;L".l());if(!this.editClicked){this.editClicked=true;}}});Ext.ns("bpo.widget.Personnel");bpo.widget.Personnel=Ext.extend(bpo.widget.Widget,{type:'Personnel',componentName:'personnel',sortable:null,constructor:function(config){Ext.apply(this,config);bpo.widget.Personnel.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},editClicked:false,edit:function(){if(!this.editClicked){this.editClicked=true;bpo.dimAjaxArea('dim-action-active-page');window.location="/personnel-plan";}}});Ext.ns("bpo.widget.ChartWidget");bpo.widget.ChartWidget=Ext.extend(bpo.widget.Widget,{type:'Chart',componentName:'chart',chart:null,constructor:function(config){Ext.apply(this,config);bpo.widget.ChartWidget.superclass.constructor.call(this,config);this.createChart();},createChart:function(){if(this.cleanSlateFlag){this.chart=false;return;}
var t=this;this.chartConfig.renderTo='chart-'+this.id;$j('#'+this.chartConfig.renderTo).height(400);this.chartConfig.events={click:function(){t.edit();}};if($j('#'+this.chartConfig.renderTo).length>0){bpo.createChart(this.chartConfig);}
this.on('edit',function(){if(this.chart){this.chart.destroy();}
this.chart=false;});},init:function(){this.getEl().child('.financial-table-and-row-selector .selectableItem[value=SELECT_ONE]').on('click',function(el){this.getEl().child('.chart-type-selector .selectableItem[value=SELECT_ONE] a').dom.click();},this);bpo.eventbus.on('plandatachange',function(what){window.updateChart(this.id);},this);},preview:function(){if(!this.chart){this.createChart();}
if(this.isSlateClean()&&this.getEl()){this.getEl().select(".container .clean-slate a").setDisplayed(false);this.getEl().select(".container .clean-slate a."+this.chartConfig.cleanslateMode).show();}
bpo.widget.ChartWidget.superclass.preview.call(this);},isSlateClean:function(){return this.cleanSlateFlag;},edit:function(){bpo.widget.ChartWidget.superclass.edit.call(this);this.getEl().select('.x-hidden').removeClass('.x-hidden');},setData:function(config){this.chartConfig=Ext.decode(config);if(typeof this.chartConfig.title!=='undefined'){this.setTitle(this.chartConfig.title);}
if(typeof this.chartConfig.cleanslate!=='undefined'){this.cleanSlateFlag=this.chartConfig.cleanslate;if(!this.editing){this.preview();}}}});Ext.ns("bpo.widget.Funding");bpo.widget.Funding=Ext.extend(bpo.widget.Widget,{type:'Funding',componentName:'funding',sortable:null,constructor:function(config){Ext.apply(this,config);bpo.widget.Funding.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},editClicked:false,edit:function(){if(!this.editClicked){this.editClicked=true;bpo.dimAjaxArea('dim-action-active-page');window.location="/funding";}}});Ext.ns("bpo.widget.ProjectedBalance");bpo.widget.ProjectedBalance=Ext.extend(bpo.widget.Widget,{type:'ProjectedBalance',componentName:'projectedBalance',sortable:null,constructor:function(config){Ext.apply(this,config);bpo.widget.ProjectedBalance.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},editClicked:false,edit:function(){var cfg={buttonText:{yes:'OK'.l(),no:'',or:''}};bpo.message.alert('<p>The balance sheet is a <strong>view-only</strong> table that brings together elements of the other financial tables. To change it, use the other table builders to edit the underlying data, then it will update automatically.</p>'.l(),"Editing the Balance Sheet".l());if(!this.editClicked){this.editClicked=true;}}});Ext.ns("bpo.widget.ProjectedCashFlow");bpo.widget.ProjectedCashFlow=Ext.extend(bpo.widget.Widget,{type:'ProjectedCashFlow',componentName:'projectedCashFlow',sortable:null,constructor:function(config){Ext.apply(this,config);bpo.widget.ProjectedCashFlow.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},editClicked:false,edit:function(){var cfg={buttonText:{yes:'OK'.l(),no:'',or:''}};bpo.message.alert('<p>The cash flow statement is a <strong>view-only</strong> table that brings together elements of the other financial tables. To change it, use the other table builders to edit the underlying data, then it will update automatically.</p>'.l(),"Editing the Cash Flow Statement".l());if(!this.editClicked){this.editClicked=true;}}});Ext.ns("bpo.widget.CashFlowAssumptions");bpo.widget.CashFlowAssumptions=Ext.extend(bpo.widget.Widget,{type:'CashFlowAssumptions',componentName:'cashFlowAssumptions',sortable:null,constructor:function(config){Ext.apply(this,config);bpo.widget.CashFlowAssumptions.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},editClicked:false,edit:function(){if(!this.editClicked){this.editClicked=true;bpo.dimAjaxArea('dim-action-active-page');window.location="/cash-flow-assumptions";}}});Ext.ns("bpo.widget.StartingBalances");bpo.widget.StartingBalances=Ext.extend(bpo.widget.Widget,{type:'StartingBalances',componentName:'startingBalances',sortable:null,constructor:function(config){Ext.apply(this,config);bpo.widget.StartingBalances.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},editClicked:false,edit:function(){if(!this.editClicked){this.editClicked=true;bpo.dimAjaxArea('dim-action-active-page');window.location="/starting-balances";}}});Ext.ns("bpo.widget.AppendixTable");bpo.widget.AppendixTable=Ext.extend(bpo.widget.Widget,{type:'AppendixTable',componentName:'appendixTable',sortable:null,cleanSlateFlag:false,constructor:function(config){Ext.apply(this,config);bpo.widget.AppendixTable.superclass.constructor.call(this,config);},init:function(){},isSlateClean:function(){return this.cleanSlateFlag;},setCleanSlateFlag:function(isCleanSlateFlag){this.cleanSlateFlag=isCleanSlateFlag;if(this.editing===false){this.preview();}},editClicked:false,edit:function(){bpo.message.alert('<p>'+"The monthly tables shown in the appendix are <strong>view-only</strong>. "+"To change them, go to the related table builders and edit the underlying data.".l()
+"</p>","Editing the Appendix".l());if(!this.editClicked){this.editClicked=true;}}});