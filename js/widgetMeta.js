
bpo.WidgetRegistry=Ext.extend(Ext.util.Observable,{section:1,chapter:1,lastSaved:false,removeOnInit:true,widgets:new Ext.util.MixedCollection(false,function(x){return x.id;}),constructor:function(config){Ext.apply(this,config);bpo.WidgetRegistry.superclass.constructor.call(this,config);this.addEvents({init:true});Ext.onReady(function(){Ext.select('#main, #plan-header, #header-tabs').on({'click':this.onClick,scope:this});$j('.comment textarea').live('keydown keyup',function(){var el=this,fn=function(){bpo.limitCommentText(el,5000);};window.setTimeout(fn,1);});},this);bpo.eventbus.on('changepage',function(){this.previewAll();},this);},onClick:function(e,target){if(this.getWidgets().getCount()===0){return;}
var el=Ext.get(target);if(el.hasClass('intro-block-toggle')||el.findParent('.do-not-edit')){return;}
var tgt=Ext.fly(target).parent('a')||Ext.get(target);var commentEl=Ext.fly(target).findParent('.comments-wrapper');if(commentEl){var commentNodeId=commentEl.getAttribute('rel');var commentWidget=this.getWidget(commentNodeId);if(tgt.is('.add-comment')){var newCommentString=$j(tgt.dom).parents('div.entry').find('textarea.newCommentText').val().trim();var escapedCommentString=Ext.util.Format.stripTags(newCommentString);if(escapedCommentString.length<=5000){$j(tgt.dom).parents('div.entry').find('.newCommentText').val("");$j(tgt.dom).parents('div.entry').find('.newCommentCountdown').text("");commentWidget.addComment(newCommentString);}
return;}else if(tgt.is('.reveal-comments')){$j(tgt.dom).parents('div.comment-reveal').siblings('.comment').slideDown(100);$j(tgt.dom).parents('div.comments-wrapper').addClass('comments-reveal-all');$j(tgt.dom).parents('div.comment-reveal').hide();}
var commentId=null;if(tgt.findParent('.comment')){commentId=tgt.findParent('.comment').getAttribute('rel');}
if(tgt.is('.edit-comment')){commentWidget.editComment(commentId);}else if(tgt.is('.cancel-edit-comment')){commentWidget.cancelEditComment(commentId);}else if(tgt.is('.save-comment')){commentWidget.saveComment(commentId);}else if(tgt.is('.delete-comment')){commentWidget.deleteComment(commentId);}}
var widgetEl=Ext.fly(target).findParent('.widget'),widget;if(widgetEl){widget=this.getWidget(widgetEl.id);if(widget&&!widget.editing){if(!this.readOnly&&!widget.readOnly){widget.edit();}}else{if(tgt.is('.instructions-toggle')||tgt.is('.hide-show')){widget.toggleInstructions();}else if(tgt.is('.rename')){widget.rename();}else if(tgt.is('.close')){widget.preview();}else if(tgt.is('.expert-advice')){}else if(tgt.is('.expert-advice-iframe')){widget.showExpertAdviceIFrame();}else if(tgt.is('.continue')){this.editContinue();}}}else{}},addWidget:function(widget){if(widget.id===null){throw"Widget must have id";}
if(this.widgets.containsKey(widget.id)){this.destroyWidget(this.widgets.get(widget.id));}
this.widgets.add(widget);widget.addListener('updated',this.widgetUpdated,this);widget.on({'updated':this.widgetUpdated,'edit':function(cmp){this.previewAll(widget);},'saved':this.onSaved,scope:this});widget.getEl().show();},destroyWidget:function(widget){var event,eventName,listener;widget.fireEvent('destroy');this.widgets.remove(widget);widget.purgeListeners();for(eventName in this.events){if(this.events.hasOwnProperty(eventName)){event=this.events[eventName];if(event.listeners!==null){for(listener in event.listeners){if(event.listeners.hasOwnProperty(listener)){if(listener.scope===widget){this.removeListener(eventName,listener.fn,listener.scope);}}}}}}
Ext.destroy(widget);},clear:function(){this.setReadOnly(false);this.widgets.each(function(widget){this.destroyWidget(widget);},this);this.purgeListeners();this.widgets.clear();},getWidget:function(id){if(typeof id==="object"){id=id.id;}
return this.widgets.get(id);},getWidgets:function(){return this.widgets;},getWidgetsByType:function(type){if(typeof type==="string"){type=bpo.widget[Ext.util.Format.capitalize(type.split('.').pop())];}
return this.getWidgets().filterBy(function(o,k){return(o&&type&&o instanceof type);});},getEditor:function(){return this.getWidgets().find(function(w){return w.editing;})||false;},previewAll:function(excepting){this.widgets.each(function(widget){if(!widget){return;}else if(typeof excepting==='undefined'||widget.id!==excepting.id){widget.preview();}});},setReadOnly:function(roval,skipAddClass){if(!skipAddClass){Ext.get('content')[roval?'addClass':'removeClass']('read-only');}
this.widgets.each(function(widget){widget.readOnly=roval;});},getReadOnly:function(){var roval=false;this.widgets.each(function(widget){roval=widget.readOnly&&roval;});},dimWidgets:function(){var finalOpacity=0.4;if(this.getWidgets().getCount()===0){return;}
this.previewAll();this.setReadOnly(true);var i=0;var retreatFlag=function(el){el.child('.flag').animate({width:{to:0}},0.35,function(){el.child('.tuck').animate({width:{to:48}},0.1,function(){el.parent('.widget').setOpacity(finalOpacity,true);},'easeIn','run');},'easeOut','run');};Ext.select('.click-to-edit',true).each(function(el){retreatFlag.defer(i,null,[el]);i+=100;});var fn=function(){Ext.get('widgets-container').createChild({cls:'loading-widgets'}).center('widgets-container');};fn.defer(i);},editContinue:function(){this.getEditor().preview();},updateWidgetNumbers:function(){var mapping={};Ext.select('.widgets .widget').each(function(el,c,idx){this.getWidget(el.id).setOutline(idx+1);},this);},widgetUpdated:function(widget){bpo.dwrBatch.beginBatch();try{console.log("Updated: "+widget.type+" : "+widget.id);this.fireEvent('updated',this,widget);this.fireEvent(widget.type+".updated",this,widget);}catch(exception){console.log(exception);}finally{bpo.dwrBatch.endBatch();}},save:function(){this.lastSaved=new Date();this.previewAll();this.getWidgets().each(function(w){if(w.save){w.save.createDelegate(w);}},this);},onSaved:function(){var now=new Date();$j('span.last-saved').html('Last saved <span class="timeago" title=""></span>');$j('span.last-saved .timeago').html(now.format('l, F d, Y g:i:s A'));$j('span.last-saved .timeago').attr("title",now.format('c'));$j('span.last-saved span.timeago').timeago();},handleProcessResult:function(node,context){},initAllWidgets:function(){Ext.select('body').removeClass('edit-node');if(this.removeOnInit){this.clear();}
Ext.select('.widgets .widget').each(function(widget){if(widget.child('.widget-config')){var widgetConfig=Ext.decode(widget.child('.widget-config').getValue());this.addWidget(new bpo.widget[widgetConfig.xtype](widgetConfig));}},this);$j('.comments-wrapper').show();if(this.getWidgets().getCount()===0){return;}
bpo.dwrBatch.beginBatch();try{this.fireEvent('init',this);}catch(exception){console.log(exception);}
finally{bpo.dwrBatch.endBatch();}
$j('span.last-edited span.timeago, abbr.timeago').timeago();var commentSections=$j('.comment-reveal');for(var i=0;i<commentSections.length;i++){this.hideComments(commentSections[i]);}
this.previewAll();},hideComments:function(commentsRevealDiv){if($j(commentsRevealDiv).parents('div.comments-wrapper').find('.comment-toggle').hasClass('expanded')){$j(commentsRevealDiv).parents('.comments').slideDown(100);$j(commentsRevealDiv).hide();}else{if($j(commentsRevealDiv).parents('div.comments-wrapper').hasClass('comments-reveal-all')===false){var totalCount=$j(commentsRevealDiv).siblings('.comment').size();if(totalCount>3){$j(commentsRevealDiv).siblings('.comment').slice(0,totalCount-3).hide();}}
if($j(commentsRevealDiv).siblings('.comment').size()<4||$j(commentsRevealDiv).parents('div.comments-wrapper').hasClass('comments-reveal-all')===true){$j(commentsRevealDiv).hide();}}}});bpo.widgetRegistry=new bpo.WidgetRegistry();Ext.ns("bpo.widget");bpo.widget.Widget=Ext.extend(Ext.util.Observable,{id:null,type:null,componentName:null,editing:false,readOnly:false,constructor:function(config){Ext.apply(this,config);this.addEvents({'preview':true,'edit':true,'cleanslate':true,'remove':true,'saved':true,'settitle':true});if(this.lastEditedDate){this.lastEditedDate=new Date.parseDate(this.lastEditedDate,'c');}
if(this.clickToEditText){this.updateClickToEditText(this.clickToEditText);}
this.title=this.getEl().child('.title').dom.innerHTML;bpo.widget.Widget.superclass.constructor.call(this,config);var el=this.getEl();if(!this.readOnly){el.addClassOnOver('hover');}
bpo.widgetRegistry.addListener("init",this.init,this);this.on('edit',this.formatExamples,this,{single:true});},init:function(){if(this.inited){return;}
$j('.widgets').each(function(){if($j(this).children('.widget').size()===0){$j(this).addClass('empty');}else{$j(this).removeClass('empty');}});if(this.wasEdited){this.updateLastEdited();}
var el=$j(this.getEl().dom);el.find('.instructions-nav').tabs('div.help-pages > div.help-page',{tabs:'a',current:'active',onClick:function(){el.addClass("xxx").removeClass("xxx");}});this.inited=true;},updateLastEdited:function(){var lastEdited='Last edited by'.l()+' {0} <span class="last-edited"><span class="timeago" title="{1}">{2}</span></span>';$j("#"+this.id+" span.save-status").html(String.format(lastEdited,this.lastEditedUsername,this.lastEditedDate.format('c'),this.lastEditedDate.format('l, F d, Y g:i:s A')));$j("#"+this.id+' span.last-edited span.timeago').timeago();$j("#"+this.id+' div.click-to-edit').removeClass("hover");},onClick:function(e,target){},getEl:function(){return Ext.get(this.id);},getCommentsEl:function(){return Ext.select('.comments-wrapper[rel='+this.id+']').first();},getCommentEl:function(commentUuid){return this.getCommentsEl().child('.comment[rel='+commentUuid+']');},rename:function(){bpo.message.prompt({maxLength:255},this.title,function(newTitle){window.renameNode(this.outlineUuid,newTitle);this.title=Ext.util.Format.htmlEncode(newTitle);this.setTitle(Ext.util.Format.htmlEncode(newTitle));}.createDelegate(this));},preview:function(){if(this.isSlateClean()){this.cleanSlate();}else{var el=this.getEl();this.editing=false;if(el){this.getEl().removeClass(['edit','clean-slate']).addClass('preview');$j('.preview-table').each(function(){var previewEl=$j(this);var fullWidth=previewEl.totalWidth();if(fullWidth>previewEl.width()){previewEl.width(fullWidth);previewEl.parent().css({'overflow':'auto'});}});}}
this.fireEvent('preview',this);},isSlateClean:function(){return false;},cleanSlate:function(){var el=this.getEl();this.editing=false;if(el){this.getEl().removeClass('edit').addClass(['clean-slate','preview']);this.fireEvent('cleanslate',this);}},edit:function(){if(this.readOnly){return;}
this.getEl().removeClass(['preview','clean-slate']).addClass('edit');this.editing=true;this.fireEvent('edit',this);var id=bpo.timer.start();this.on('preview',function(){bpo.trackEvent('Outline Item Edit',this.type+' Edit',this.businessKey,bpo.timer.stop(id));},this,{single:true});},saved:function(){this.fireEvent("saved",this);this.lastEditedDate=new Date();this.lastEditedUsername=bpo.plan.currentUser;this.updateLastEdited();},mask:function(){this.getEl().child('.container').mask();},unmask:function(){this.getEl().child('.container').unmask();},destroy:function(){},toggleInstructions:function(){var el=this.getEl(),instructionEl=el.child('.instructions-toggle');if(instructionEl.hasClass('expanded')){this.getEl().child('.instructions').slideOut('t',{duration:0.1,useDisplay:true,callback:function(){el.repaint();}});instructionEl.removeClass('expanded');window.planRemote.toggleShowInstructions(this.outlineId,false);}else{this.getEl().child('.instructions').slideIn('t',{duration:0.1,useDisplay:true,callback:function(){el.repaint();}});instructionEl.addClass('expanded');window.planRemote.toggleShowInstructions(this.outlineId,true);}},formatExamples:function(){var el=$j(this.getEl().dom);el.find('.examples-nav').tabs(el.find('.examples-container .page'),{tabs:'li',current:'active',initialIndex:0,onClick:function(){el.addClass("xxx").removeClass("xxx");}});var tabs=el.find('.examples-nav').data('tabs');var pager=this.getEl().select('.example-pager');pager.addClassOnOver('over');pager.on('click',function(e,el){if($j(el).parent().hasClass('next')){tabs.next();}else{tabs.prev();}});this.getEl().select('.use-this-example').on('click',this.useExample,this);},useExample:Ext.emptyFn,setStatus:function(status){this.getEl().child('last-edited').update(status||this.lastEdited||"");},setTitle:function(title){this.getEl().child('h2 .title').update(title||"");this.title=title;this.fireEvent("settitle",title);},setOutline:function(widgetNumber,section,chapter){var outlineAddress=this.outlineAddress.split('.');outlineAddress[0]=chapter||outlineAddress[0];outlineAddress[1]=section||outlineAddress[1];outlineAddress[2]=widgetNumber||outlineAddress[2];this.getEl().child('.outline-num').update(outlineAddress.join('.'));this.outlineAddress=outlineAddress.join('.');},getComponent:function(){if(this.componentName===null){throw"componentName must be defined";}
return window[this.componentName];},handleWidgetUpdated:function(registry,widget){console.log("Received event from widget: "+widget.type+" : "+widget.id);},createScopedCallback:function(callbackFunction){var widget=this;return function(data){callbackFunction.call(widget,data);};},updateClickToEditText:function(text){if(this.getEl()!==null){this.getEl().child('.click-to-edit-text').update(text);}},showExpertAdvice:function(){var guessUrl,loadUrl=function(url){$j('.expert-content').html('<img style="margin: 50px 452px;" align="center" src="images/facebook-loader.gif" />');$j.ajax({url:url,type:'GET',dataType:'jsonp',data:{feed:'json'},jsonp:"jsonp",jsonpCallback:'expertAdviceCallback',success:function(data){$j('.expert-content').html(data[0].content);$j('#expertMask').height(Math.max($j('#global-wrapper').height()+2,Math.ceil(parseFloat($j('#expert-advice').css('top')))+$j('#expert-advice').height()+60));}});};$j('.expert-content').html("");if(null===$j('#expert-advice').data('overlay')){$j('#expert-advice').overlay({load:true,close:'a.close',top:'10%',oneInstance:false,closeOnClick:false,speed:'0',fixed:false,onBeforeLoad:function(){if($j.mask.isLoaded()){$j.mask.close();$j('.overlay:visible').addClass('temp');}},onClose:function(){if($j('.overlay').is('.temp')){$j.mask.getMask().expose({color:'#ffffff',zIndex:10000,loadSpeed:'0',startOpacity:'.8'});$j('.overlay.temp').removeClass('temp');}},mask:{maskId:'expertMask',color:'#111111',closeOnClick:false,closeOnEsc:false,opacity:0.9,loadSpeed:'0',zIndex:10050}});$j('#expert-advice').delegate("a",'click',function(event){var tgt=$j(event.target),href=tgt.attr('href');if(tgt.hasClass('extlink')){tgt.attr('target','_blank');return true;}else{event.preventDefault();loadUrl('http://coonrod.org/wp3/'+href);}
return false;});$j('#expert-advice').delegate("a",'mouseover',function(event){var tgt=$j(event.target),href=tgt.attr('href');});}else{$j('#expert-advice').overlay().load();}
guessUrl=String.format('http://coonrod.org/wp3/{0}/',this.title.toLowerCase().replace(/\s/g,'-'));console.log(guessUrl);loadUrl(this.expertURL||guessUrl);},showExpertAdviceIFrame:function(){var url=this.expertURL||'http://coonrod.org/wp3/distribution/';$j('.expert-content').html("");if(null===$j('#expert-advice').data('overlay')){$j('#expert-advice').overlay({load:true,close:'a.close',top:'10%',oneInstance:false,closeOnClick:false,speed:'0',onBeforeLoad:function(){if($j.mask.isLoaded()){$j.mask.close();$j('.overlay:visible').addClass('temp');}},onClose:function(){if($j('.overlay').is('.temp')){$j.mask.getMask().expose({color:'#ffffff',zIndex:10000,loadSpeed:'0',startOpacity:'.8'});$j('.overlay.temp').removeClass('temp');}},mask:{maskId:'expertMask',color:'#111111',closeOnClick:false,closeOnEsc:false,opacity:0.9,loadSpeed:'0',zIndex:10050}});}else{$j('#expert-advice').overlay().load();}
$j('.expert-content').html('<iframe style="width: 920px; height: 600px;" src="'+url+'?theme=Blanky%20Blank'+'"></iframe>');},editComment:function(commentUuid){var editComment=this.getCommentEl(commentUuid);var originalText=$j(editComment.child('textarea').dom).val();$j(editComment.child('textarea').dom).data('original',originalText);editComment.addClass('entry');editComment.child('.comment-wrapper').setDisplayed(false);editComment.child('.edit-comment-wrapper').show();bpo.limitCommentText(editComment.child('textarea').dom,5000);},cancelEditComment:function(commentUuid){var editComment=this.getCommentEl(commentUuid);editComment.removeClass('entry');editComment.child('.comment-wrapper').setDisplayed(true);editComment.child('.edit-comment-wrapper').setDisplayed(false);var originalText=$j(editComment.child('textarea').dom).data('original');$j(editComment.child('textarea').dom).val(originalText);},saveComment:function(commentUuid){var saveComment=this.getCommentEl(commentUuid);var editText=$j.trim(saveComment.child('textarea').getValue());var escapedEditText=Ext.util.Format.htmlEncode(editText);if(escapedEditText.length>5000){return;}
if(editText.length>0){window.editComment(commentUuid,editText,this.outlineUuid);$j(saveComment.child('textarea').dom).data('original',editText);$j(saveComment.child('.comment-wrapper p').dom).html(Ext.util.Format.nl2br(escapedEditText));this.cancelEditComment(commentUuid);}},deleteComment:function(commentUuid){var deleteComment=this.getCommentEl(commentUuid);var deleteFn=function(id){if(id==='yes'){window.removeComment(commentUuid);deleteComment.ghost('b',{remove:false,scope:this,callback:function(){deleteComment.update('').slideOut('t',{remove:true,scope:this,callback:function(){this.updateRevealCommentsText();this.updateShownComments();}});}});}};bpo.message.confirm(false,"Are you sure you want to delete this comment?",deleteFn,this);},addComment:function(newCommentString){var start=$j(this.getCommentsEl().dom);if(newCommentString.length===0){return;}
var escapedCommentString=Ext.util.Format.htmlEncode(newCommentString);if(escapedCommentString.length>5000){return;}
window.addNewComment(this.outlineUuid,newCommentString);start.find('.add-comment').addClass('disabled');var now=new Date();var nowString=now.format('l, F d, Y g:i:s A');var iso8601=now.format('c');var commentHtml='<div class="comment new-comment">';commentHtml+='<div class="avatar"></div>';commentHtml+='<div class="comment-wrapper">';commentHtml+='<h4 class="author overflowable">'+bpo.plan.currentUser+'</h4>';commentHtml+='<abbr class="timeago" title="'+iso8601+'">'+nowString+'</abbr>';commentHtml+='<div class="comment-controls">';commentHtml+='<a href="javascript:void(0);" class="edit-comment">Edit this comment</a>';commentHtml+='<a href="javascript:void(0);" class="delete-comment">Delete</a>';commentHtml+='</div>';commentHtml+='<p></p>';commentHtml+='</div>';commentHtml+='<div class="edit-comment-wrapper">';commentHtml+='<div style="float:left">';commentHtml+='<textarea class="newCommentText" title="Write a comment" placeholder="Write a comment"></textarea>';commentHtml+='<br/>';commentHtml+='<span class="newCommentCountdown" style="color:#666;line-height:1.5em;"></span>';commentHtml+='</div>';commentHtml+='<div class="comment-edit-controls">';commentHtml+='<a href="javascript:void(0);" data-commentid="#{comment.uuid}" class="save-comment button button-gray-small x-unselectable"><span class="button-cap"><span style="margin: 0pt auto;">Save</span></span></a>';commentHtml+='<div>or</div>';commentHtml+='<a href="javascript:void(0);" rel="#{widget.uuid}" class="cancel-edit-comment">Cancel</a>';commentHtml+='</div>';commentHtml+='</div>';commentHtml+='</div>';var commentElement=$j(commentHtml);commentElement.find('p').html(Ext.util.Format.nl2br(escapedCommentString));commentElement.find('textarea').html(escapedCommentString);commentElement.find('span.newCommentCountdown').html(''+(5000-escapedCommentString.length)+' characters remaining');start.find('.entry.add-new-comment').before(commentElement.hide());commentElement.slideDown('fast');this.updateRevealCommentsText();this.updateShownComments();start.find('textarea#newCommentText').val('').height('');$j('abbr.timeago').timeago();},addNewCommentCallback:function(newCommentUuid){var newCommentEl=$j(this.getCommentsEl().dom).find('.comment.new-comment');newCommentEl.removeClass('new-comment');newCommentEl.attr('rel',newCommentUuid);},editCommentCallback:function(commentExists,commentUuid){if(commentExists==='false'){var deleteComment=this.getCommentEl(commentUuid);deleteComment.ghost('b',{remove:false,scope:this,callback:function(){deleteComment.update('').slideOut('t',{remove:true,scope:this,callback:function(){this.updateRevealCommentsText();this.updateShownComments();}});}});}},updateRevealCommentsText:function(){var start=$j(this.getCommentsEl().dom),revealLink=$j(this.getCommentsEl().dom).find('.comment-reveal'),commentEls=$j(this.getCommentsEl().dom).find('.comment');var numberOfComments=commentEls.size()-1;start.find('a .comment-count').fadeOut('fast',function(){$j(this).text(numberOfComments);}).fadeIn();if(numberOfComments<3){start.find('a .comment-term').fadeOut('fast',function(){$j(this).text(numberOfComments===1?"comment".l():"comments".l());}).fadeIn();}
if(numberOfComments<3||start.hasClass('comments-reveal-all')){revealLink.hide();}else{revealLink.show();}},updateShownComments:function(){var commentEls=$j(this.getCommentsEl().dom).find('.comment');if(commentEls.size()>=3&&!$j(this.getCommentsEl().dom).hasClass('comments-reveal-all')){var commentsToHide=commentEls.size()-3;commentEls.each(function(idx){if(idx<commentsToHide&&$j(this).is(':visible')){$j(this).slideUp(100);}else if(idx>=commentsToHide&&!$j(this).is(':visible')){$j(this).slideDown(100);}});}}});